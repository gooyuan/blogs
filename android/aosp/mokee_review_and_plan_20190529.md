
## mokee 研究计划

1. 当前进度

mokee 系统, 当前已经可以正常编译, 但是目前mokee支持的机型大多都是手机上市后1年以上的, 这不满足诱发机供货需求, 所以, 系统级诱发机这条路还是要自己适配定制才行. 

根据这段时间的查找研究, 目前已大致了解了定制系统ROM工作流程

2. 初探

查看当前手机cpu是芯片的内核是否有开源的, 编译内核, 如果使用预编译的内核

3. 先跑起来再说

编写devices库, 这个可以参考已适配的同等cpu型号的固件, 没有的话, 参考同厂商上一版本的配置文件

编写 device 是一个很复杂的过程，很多编译参数需要去考究去查。

这一步基本上就是写 device…尝试编译…炸了，改，编译…炸了，改，编译…好的终于编译完毕了（可能耗时一个星期）。

重启进 fastboot，刷镜像…炸了，卡厂商 LOGO…改，编译，刷，炸，改，编译，刷…好了，终于能看到开机动画了。

咦，一直是动画…adb logcat 看看是哪个部件炸了…改，编译，刷，炸…咦缺了些私有库。补，编译，炸，改…………………………

4. 修，修，修…

欧耶，终于进桌面了。boom，「XXX 屡次停止运行」。好，看 logcat，改……

咦，没有基带？找找找…改改改…咦？蓝牙怎么挂了？Wi-Fi 也挂了？？？改…………

我日，怎么相机也挂了？改改改改改………

好的，基本上就又一个星期过去了。

这时候大致上可以叫龙猪跑个 EXPERIMENTAL 出来玩玩了。

5. 优化

厂商开源的内核可能不是最新的，有些有能力的适配者会自己更新一些东西。

内核 tag 老了？合！
Wi-Fi（qcacld）驱动太旧？合！
SDCardFS 也老了？合！
内核版本也老了！合！！！（此条仅限极少数非常牛逼的适配者）

kernel 编译, 查找预编译库

    涉及到相关驱动: 摄像头, 基带, 呼吸灯, wifi, 蓝牙, 陀螺仪, Audio, telephony, nfc, power, recovery

    部分可以直接用, 有些需要适配,写shim层代码

device 库编写: 
    参考现成的cpu机型, 参考厂商前一代型号的device
    先以nubia z17minis 为目标, 移植一版rom, cpu 为 qcom msm8976

HAL层研究:

研究的意义: 
可定制性强, 内核源码理论上是都开源的, 因为, linux支持不同架构, 需要相应的公司去维护对应的驱动. linux 4.7 主线版本以后, 还对龙芯(MIPS) 架构的支持合并了, 主要就是龙芯团队一直在维护着linux的适配工作, 所以, 龙芯其实很吊. 
一旦研究成了, 可选择机型更多了, 大不了自己适配五款, 而且是诱发功能更稳定, 若有什么问题, 可以尝试着从系统级来修改了, 所以, 对于公司的意义还是很大的, 当然, 对于我自己的意义也非凡, 至少可以加工资, 也可以申请Mokee的一款机型移植. 
 
## 计划制定

对于mokee系统码源级诱发研究, 目前已获得mokee源码, 配置好环境可正常编译, 但由于mokee系统是第三方组织维护, 所支持的机型大部分都是上市1年以上的机型. 这与我们的诱发机出货选择条件相冲突, 因此对于新上市/有货源的机型, 需要自研适配工作. 

经过这段时间的研究, 初步确定了适配整个适配工作的初步流程: 

1. 根据诱发机的芯片, 查找对应的内核源码或预编译内核.

    此过程需要研究内核源码编译, 并与当前android系统代码对接, 难度适中, 主要精力放在与系统代码的编译对接上

2. 编写device文件夹下的配置与编译脚本

    此过程比较复杂, 涉及到的内容比较多, 有audio, gps, keylayout, libshims, nfc, overlay, sensors, wifi, sepolicy, twrp
    目前主要研究的机型放在nubia, 和 一加, 这些都是高通芯片, 可以参考已适配的旧机型的device文件, 弄懂每一块硬件相关, 编译相关的各种参数是一个不小的工作量, 特别是shims层, 需要根据vendor编写的HAL层的二进制文件(无源码), 根据反编译代码写shim层代码来驱动硬件工作起来, 有难度. 

3. 修复运行错误, 保证基本功能正常

    上一步骤搞定, 可以正常编译, rom 刷到手机可以正常进入系统首面, 初步运行起来肯定会有一堆的运行错误, 然后再持续反复编译调试, 达到基本的功能可用, rom 移植工作算初步完成, 后续工作就是再根据新需求定制.

**风险点**主要在编写shim层, 因为HAL层涉及到多种硬件: 音频, gps, 基带, wifi, 传感器, nfc, 摄像头, 蓝牙, 多媒体, 输入设备

诱发机主要关注基带, 蓝牙, wifi, 但是其他模块也要保证基本可用, 才能保证整个系统正常工作. 

以z17 minis为研究机型, 计划表如下: 

|任务名称| 任务周期|
|--|--|
|sms8967内核源码编译与预编译内核适配| 5天
|devices文件夹下脚本编写: <br/> 涉及audio, gps, keylayout, libshims, nfc,<br/> overlay, sensors, wifi, sepolicy, twrp, 等|15天
|rom 调试, 相关模块: <br/>音频, gps, 基带, wifi, 传感器, nfc, 摄像头,<br/> 蓝牙, 多媒体, 输入设备, 等| 9天

PS: 
由于手上仍负责其他两个项目: 数传终端, 主被结合, 因此在研究mokee系统期间会临时被其他任务中断, 最近几周, 数传终端的需求就比较急, 所以, 此计划只列举大概周期, 遇到项目调节, 以及可能的技术难点障碍, 研究周期仍可能延长. 


